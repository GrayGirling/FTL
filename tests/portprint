#!/usr/bin/env ftl

set outserv[port,out]:{
    io.fprintf io.out "Wait for connection on port %d..."<port>!;
    io.flush io.out!;
    .p = io.listen "tcp" (strf "%d"<port>!) "r"!;
    io.write io.out "\n"!;
    if p != NULL {
        .ok = TRUE;
        .idle = TRUE;
        do {
            idle=TRUE;
            not (io.inblocked io.in!) {
                idle = FALSE;
                c = io.getc io.in!;
                io.fprintf io.err "in: %v\n"<c>!;
            }!;
            not (io.inblocked p!) {
                .data = io.read p 100!;
                idle = FALSE;
                io.fprintf io.err "read %v [%d]\n"<
                       data, if data==NULL{0}{len data!}!>!;
                ok = data != NULL {data != ""}! {
                    (io.write out data!) _gt_ 0
                }!;
            }!;
            idle { sleep 1! }!;
        } { ok }!;
        TRUE
    }{ io.fprintf io.out "Failed to open TCP port %d\n"<port>!; FALSE }!
}



set remout NULL

set locservout[port]:{
    remout = io.connect "tcp"  (strf ":%d"<port>!) "w"!;
    if remout != NULL {
       io.fprintf io.out "Opened local TCP port %d\n"<port>!; TRUE
    }{ io.fprintf io.out "Failed to open TCP port %d\n"<port>!; FALSE
    }!
}


set rprintf[fmt, info]:{ io.fprintf remout fmt info! }

set rclose[]: { io.close remout! }
